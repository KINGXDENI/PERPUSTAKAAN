<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Member Perpustakaan</title>
  <link href="https://cdn.tailwindcss.com" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11">
</head>
<body class="bg-gray-100">
  <header class="bg-blue-600 text-white py-4">
    <div class="container mx-auto text-center">
      <h1 class="text-3xl font-semibold">Sistem Member Perpustakaan Daerah</h1>
    </div>
  </header>

  <main class="container mx-auto my-8">
    <section id="form-section" class="mb-8">
      <div class="bg-white shadow-md rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Tambah Member Baru</h2>
        <form id="member-form">
          <input type="text" id="id" placeholder="Nomor Anggota" required class="input-field" />
          <input type="text" id="name" placeholder="Nama" required class="input-field" />
          <input type="date" id="birthdate" required class="input-field" />
          <textarea id="address" placeholder="Alamat" required class="input-field"></textarea>
          <select id="gender" required class="input-field">
            <option value="">Pilih Jenis Kelamin</option>
            <option value="Laki-Laki">Laki-Laki</option>
            <option value="Perempuan">Perempuan</option>
          </select>
          <input type="email" id="email" placeholder="Email" required class="input-field" />
          <input type="tel" id="phone" placeholder="Nomor Telepon" required class="input-field" />
          <input type="date" id="validity" required class="input-field" />
          <button type="submit" class="btn-submit">Tambah Member</button>
        </form>
      </div>
    </section>

    <section id="member-list-section">
      <div class="bg-white shadow-md rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Daftar Member</h2>
        <div class="overflow-x-auto">
          <table id="member-table" class="w-full border">
            <thead>
              <tr>
                <th>No. Anggota</th>
                <th>Nama</th>
                <th>TTL</th>
                <th>Alamat</th>
                <th>Jenis Kelamin</th>
                <th>Email</th>
                <th>Telepon</th>
                <th>Masa Berlaku</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="member-table-body">
              <!-- Member akan ditambahkan di sini -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const apiUrl = "https://perpustakaan.dibo.biz.id/api/members";
    const form = document.getElementById("member-form");
    const memberTableBody = document.getElementById("member-table-body");

    document.addEventListener("DOMContentLoaded", fetchMembers);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const memberData = {
        id: document.getElementById("id").value,
        name: document.getElementById("name").value,
        birthdate: document.getElementById("birthdate").value,
        address: document.getElementById("address").value,
        gender: document.getElementById("gender").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        validity: document.getElementById("validity").value,
      };
      try {
        await axios.post(apiUrl, memberData);
        form.reset();
        fetchMembers();
        Swal.fire("Berhasil", "Member ditambahkan", "success");
      } catch {
        Swal.fire("Gagal", "Terjadi kesalahan", "error");
      }
    });

    async function fetchMembers() {
      try {
        const response = await axios.get(apiUrl);
        displayMembers(response.data);
      } catch {
        console.error("Gagal memuat data member");
      }
    }

    function displayMembers(members) {
      memberTableBody.innerHTML = "";
      members.forEach((member) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${member.id}</td>
          <td>${member.name}</td>
          <td>${new Date(member.birthdate).toLocaleDateString('id-ID')}</td>
          <td>${member.address}</td>
          <td>${member.gender}</td>
          <td>${member.email}</td>
          <td>${member.phone}</td>
          <td>${new Date(member.validity).toLocaleDateString('id-ID')}</td>
          <td>
            <button class="edit-btn" data-member='${JSON.stringify(member)}'>Edit</button>
            <button class="delete-btn" data-id="${member.id}">Hapus</button>
          </td>`;
        memberTableBody.appendChild(row);
      });

      document.querySelectorAll(".edit-btn").forEach(button => {
        button.addEventListener("click", () => {
          const member = JSON.parse(button.getAttribute("data-member"));
          editMember(member);
        });
      });

      document.querySelectorAll(".delete-btn").forEach(button => {
        button.addEventListener("click", () => {
          const memberId = button.getAttribute("data-id");
          confirmDelete(memberId);
        });
      });
    }

    function confirmDelete(id) {
      Swal.fire({
        title: "Yakin ingin hapus?",
        text: "Data tidak dapat dikembalikan!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Ya, Hapus!",
        cancelButtonText: "Batal",
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await axios.delete(`${apiUrl}/${id}`);
            fetchMembers();
            Swal.fire("Terhapus!", "Data berhasil dihapus.", "success");
          } catch {
            Swal.fire("Gagal", "Tidak dapat menghapus data.", "error");
          }
        }
      });
    }

    function editMember(member) {
      Swal.fire({
        title: "Edit Member",
        html: `
          <input id="edit-id" class="swal2-input" value="${member.id}" readonly />
          <input id="edit-name" class="swal2-input" value="${member.name}" />
          <input id="edit-birthdate" type="date" class="swal2-input" value="${member.birthdate}" />
          <textarea id="edit-address" class="swal2-input">${member.address}</textarea>
          <select id="edit-gender" class="swal2-input">
            <option value="Laki-Laki" ${member.gender === "Laki-Laki" ? "selected" : ""}>Laki-Laki</option>
            <option value="Perempuan" ${member.gender === "Perempuan" ? "selected" : ""}>Perempuan</option>
          </select>
          <input id="edit-email" class="swal2-input" value="${member.email}" />
          <input id="edit-phone" class="swal2-input" value="${member.phone}" />
          <input id="edit-validity" type="date" class="swal2-input" value="${member.validity}" />
        `,
        showCancelButton: true,
        confirmButtonText: "Simpan",
        preConfirm: () => ({
          id: document.getElementById("edit-id").value,
          name: document.getElementById("edit-name").value,
          birthdate: document.getElementById("edit-birthdate").value,
          address: document.getElementById("edit-address").value,
          gender: document.getElementById("edit-gender").value,
          email: document.getElementById("edit-email").value,
          phone: document.getElementById("edit-phone").value,
          validity: document.getElementById("edit-validity").value,
        }),
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await axios.put(`${apiUrl}/${result.value.id}`, result.value);
            fetchMembers();
            Swal.fire("Berhasil", "Data diupdate", "success");
          } catch {
            Swal.fire("Gagal", "Tidak dapat mengupdate data", "error");
          }
        }
      });
    }
  </script>
</body>
</html>
